From d6a393ba588b534aabe66990be1b7b289af40cea Mon Sep 17 00:00:00 2001
From: Elvis Pranskevichus <elvis@alfheim.prans.org>
Date: Sat, 20 Dec 2008 14:49:38 -0500
Subject: [PATCH 2/2] [gentoo] Server patch

---
 GNUmakefile.in                 |    7 -------
 contrib/Makefile               |    5 +----
 contrib/adminpack/Makefile     |    2 +-
 contrib/uuid-ossp/Makefile     |    4 +++-
 contrib/xml2/Makefile          |    3 ++-
 src/Makefile                   |    6 +-----
 src/Makefile.global.in         |    4 ++--
 src/bin/Makefile               |    3 +--
 src/bin/initdb/Makefile        |    2 +-
 src/bin/pg_ctl/Makefile        |    2 +-
 src/include/pg_config_manual.h |    2 +-
 src/port/Makefile              |    5 ++---
 src/test/regress/GNUmakefile   |    2 +-
 src/test/regress/pg_regress.c  |    3 ---
 14 files changed, 17 insertions(+), 33 deletions(-)

diff --git a/GNUmakefile.in b/GNUmakefile.in
index 51e7a96..fb62993 100644
--- a/GNUmakefile.in
+++ b/GNUmakefile.in
@@ -10,7 +10,6 @@ include $(top_builddir)/src/Makefile.global
 
 all:
 	$(MAKE) -C src all
-	$(MAKE) -C config all
 	@echo "All of PostgreSQL successfully made. Ready to install."
 
 docs:
@@ -28,7 +27,6 @@ html man:
 
 install:
 	$(MAKE) -C src $@
-	$(MAKE) -C config $@
 	@echo "PostgreSQL installation complete."
 
 install-docs:
@@ -42,12 +40,9 @@ install-world:
 	@echo "PostgreSQL, contrib, and documentation installation complete."
 
 installdirs uninstall coverage:
-	$(MAKE) -C doc $@
 	$(MAKE) -C src $@
-	$(MAKE) -C config $@
 
 distprep:
-	$(MAKE) -C doc $@
 	$(MAKE) -C src $@
 	$(MAKE) -C config $@
 	$(MAKE) -C contrib $@
@@ -55,7 +50,6 @@ distprep:
 # clean, distclean, etc should apply to contrib too, even though
 # it's not built by default
 clean:
-	$(MAKE) -C doc $@
 	$(MAKE) -C contrib $@
 	$(MAKE) -C src $@
 	$(MAKE) -C config $@
@@ -65,7 +59,6 @@ clean:
 # Important: distclean `src' last, otherwise Makefile.global
 # will be gone too soon.
 distclean maintainer-clean:
-	$(MAKE) -C doc $@
 	$(MAKE) -C contrib $@
 	$(MAKE) -C config $@
 	$(MAKE) -C src $@
diff --git a/contrib/Makefile b/contrib/Makefile
index 8e18785..abf2d66 100644
--- a/contrib/Makefile
+++ b/contrib/Makefile
@@ -23,7 +23,6 @@ SUBDIRS = \
 		isn		\
 		lo		\
 		ltree		\
-		oid2name	\
 		pageinspect	\
 		passwordcheck	\
 		pg_buffercache	\
@@ -33,7 +32,6 @@ SUBDIRS = \
 		pg_trgm		\
 		pg_upgrade	\
 		pg_upgrade_support \
-		pgbench		\
 		pgcrypto	\
 		pgrowlocks	\
 		pgstattuple	\
@@ -42,8 +40,7 @@ SUBDIRS = \
 		tablefunc	\
 		test_parser	\
 		tsearch2	\
-		unaccent	\
-		vacuumlo
+		unaccent
 
 ifeq ($(with_openssl),yes)
 SUBDIRS += sslinfo
diff --git a/contrib/adminpack/Makefile b/contrib/adminpack/Makefile
index 3492d27..0857f7c 100644
--- a/contrib/adminpack/Makefile
+++ b/contrib/adminpack/Makefile
@@ -1,7 +1,7 @@
 # $PostgreSQL$
 
 MODULE_big = adminpack
-PG_CPPFLAGS = -I$(libpq_srcdir)
+PG_CPPFLAGS = -I$(libpq_srcdir) -I../../src/include/
 DATA_built = adminpack.sql
 DATA = uninstall_adminpack.sql
 OBJS = adminpack.o
diff --git a/contrib/uuid-ossp/Makefile b/contrib/uuid-ossp/Makefile
index 0eb2705..a25706d 100644
--- a/contrib/uuid-ossp/Makefile
+++ b/contrib/uuid-ossp/Makefile
@@ -1,11 +1,13 @@
 # $PostgreSQL$
 
+PG_CPPFLAGS += "-DHAVE_OSSP_UUID_H"
+
 MODULE_big = uuid-ossp
 OBJS = uuid-ossp.o
 DATA_built = uuid-ossp.sql
 DATA = uninstall_uuid-ossp.sql
 
-SHLIB_LINK += $(OSSP_UUID_LIBS)
+SHLIB_LINK += -lossp-uuid
 
 ifdef USE_PGXS
 PG_CONFIG = pg_config
diff --git a/contrib/xml2/Makefile b/contrib/xml2/Makefile
index a6f6fac..13c80db 100644
--- a/contrib/xml2/Makefile
+++ b/contrib/xml2/Makefile
@@ -4,7 +4,8 @@ MODULE_big = pgxml
 
 OBJS = xpath.o xslt_proc.o
 
-SHLIB_LINK += $(filter -lxslt, $(LIBS)) $(filter -lxml2, $(LIBS))
+PG_CPPFLAGS = $(shell xml2-config --cflags)
+SHLIB_LINK += $(shell xml2-config --libs) $(shell xslt-config --libs)
 
 DATA_built = pgxml.sql
 DATA = uninstall_pgxml.sql
diff --git a/src/Makefile b/src/Makefile
index f48bd77..73f2fc5 100644
--- a/src/Makefile
+++ b/src/Makefile
@@ -19,15 +19,11 @@ all install installdirs uninstall distprep:
 	$(MAKE) -C backend $@
 	$(MAKE) -C backend/utils/mb/conversion_procs $@
 	$(MAKE) -C backend/snowball $@
-	$(MAKE) -C include $@
-	$(MAKE) -C interfaces $@
-	$(MAKE) -C backend/replication/libpqwalreceiver $@
 	$(MAKE) -C bin $@
 	$(MAKE) -C pl $@
-	$(MAKE) -C makefiles $@
 	$(MAKE) -C test/regress $@
 
-install: install-local
+install:
 
 install-local: installdirs-local
 	$(INSTALL_DATA) Makefile.global '$(DESTDIR)$(pgxsdir)/$(subdir)/Makefile.global'
diff --git a/src/Makefile.global.in b/src/Makefile.global.in
index 5936922..f9c7ed0 100644
--- a/src/Makefile.global.in
+++ b/src/Makefile.global.in
@@ -400,10 +400,8 @@ endif
 
 
 submake-libpq:
-	$(MAKE) -C $(libpq_builddir) all
 
 submake-libpgport:
-	$(MAKE) -C $(top_builddir)/src/port all
 
 .PHONY: submake-libpq submake-libpgport
 
@@ -446,6 +444,8 @@ ifdef PROFILE
    LDFLAGS += $(PROFILE)
 endif
 
+CFLAGS += -I${top_srcdir}/src/include
+
 
 ##########################################################################
 #
diff --git a/src/bin/Makefile b/src/bin/Makefile
index 5b5b1ba..2cc102a 100644
--- a/src/bin/Makefile
+++ b/src/bin/Makefile
@@ -13,8 +13,7 @@ subdir = src/bin
 top_builddir = ../..
 include $(top_builddir)/src/Makefile.global
 
-SUBDIRS = initdb pg_ctl pg_dump \
-	psql scripts pg_config pg_controldata pg_resetxlog
+SUBDIRS = initdb pg_ctl pg_controldata pg_resetxlog
 ifeq ($(PORTNAME), win32)
 SUBDIRS+=pgevent
 endif
diff --git a/src/bin/initdb/Makefile b/src/bin/initdb/Makefile
index 8f608db..f22449c 100644
--- a/src/bin/initdb/Makefile
+++ b/src/bin/initdb/Makefile
@@ -16,7 +16,7 @@ subdir = src/bin/initdb
 top_builddir = ../../..
 include $(top_builddir)/src/Makefile.global
 
-override CPPFLAGS := -DFRONTEND -I$(libpq_srcdir) $(CPPFLAGS)
+override CPPFLAGS := -DFRONTEND -I$(top_srcdir)/src/interfaces/libpq $(CPPFLAGS)
 
 OBJS=	initdb.o encnames.o pqsignal.o $(WIN32RES)
 
diff --git a/src/bin/pg_ctl/Makefile b/src/bin/pg_ctl/Makefile
index a632515..4a85e59 100644
--- a/src/bin/pg_ctl/Makefile
+++ b/src/bin/pg_ctl/Makefile
@@ -22,7 +22,7 @@ OBJS=	pg_ctl.o $(WIN32RES)
 
 all: submake-libpq submake-libpgport pg_ctl
 
-pg_ctl: $(OBJS) $(libpq_builddir)/libpq.a
+pg_ctl: $(OBJS)
 	$(CC) $(CFLAGS) $(OBJS) $(libpq_pgport) $(LDFLAGS) $(LIBS) -o $@$(X)
 
 install: all installdirs
diff --git a/src/include/pg_config_manual.h b/src/include/pg_config_manual.h
index c5c1228..41dee52 100644
--- a/src/include/pg_config_manual.h
+++ b/src/include/pg_config_manual.h
@@ -141,7 +141,7 @@
  * here's where to twiddle it.  You can also override this at runtime
  * with the postmaster's -k switch.
  */
-#define DEFAULT_PGSOCKET_DIR  "/tmp"
+#define DEFAULT_PGSOCKET_DIR  "/var/run/postgresql"
 
 /*
  * The random() function is expected to yield values between 0 and
diff --git a/src/port/Makefile b/src/port/Makefile
index d507b94..37a59bf 100644
--- a/src/port/Makefile
+++ b/src/port/Makefile
@@ -39,11 +39,10 @@ endif
 # foo_srv.o and foo.o are both built from foo.c, but only foo.o has -DFRONTEND
 OBJS_SRV = $(OBJS:%.o=%_srv.o)
 
-all: libpgport.a libpgport_srv.a
+all: libpgport_srv.a
 
 # libpgport is needed by some contrib
-install: all installdirs
-	$(INSTALL_STLIB) libpgport.a '$(DESTDIR)$(libdir)/libpgport.a'
+install:
 
 installdirs:
 	$(MKDIR_P) '$(DESTDIR)$(libdir)'
diff --git a/src/test/regress/GNUmakefile b/src/test/regress/GNUmakefile
index 98e1e6e..72cb790 100644
--- a/src/test/regress/GNUmakefile
+++ b/src/test/regress/GNUmakefile
@@ -141,7 +141,7 @@ tablespace-setup:
 pg_regress_call = ./pg_regress --inputdir=$(srcdir) --dlpath=. --multibyte=$(MULTIBYTE) $(NOLOCALE)
 
 check: all
-	$(pg_regress_call) --temp-install=./tmp_check --top-builddir=$(top_builddir) --schedule=$(srcdir)/parallel_schedule $(MAXCONNOPT) $(TEMP_CONF)
+	$(pg_regress_call) --temp-install=./tmp_check --top-builddir=$(top_builddir) --schedule=$(srcdir)/parallel_schedule $(MAXCONNOPT) $(TEMP_CONF) --psqldir=/usr/lib/postgresql-${SLOT}/bin/
 
 installcheck: all
 	$(pg_regress_call) --psqldir=$(PSQLDIR) --schedule=$(srcdir)/serial_schedule
diff --git a/src/test/regress/pg_regress.c b/src/test/regress/pg_regress.c
index 9de4189..f0532d6 100644
--- a/src/test/regress/pg_regress.c
+++ b/src/test/regress/pg_regress.c
@@ -800,9 +800,6 @@ initialize_environment(void)
 		sprintf(tmp, "%s/install/%s", temp_install, datadir);
 		datadir = tmp;
 
-		/* psql will be installed into temp-install bindir */
-		psqldir = bindir;
-
 		/*
 		 * Set up shared library paths to include the temp install.
 		 *
-- 
1.7.0.4

